{% extends 'base.html.twig' %}

{% block title %}{{ product.name }} - {{ boutique.name }}{% endblock %}

{% block sidebar %}
    {% include '_sidebar.html.twig' with {'boutique': boutique, 'activeRoute': 'app_boutique_stocks'} %}
{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="/css/dashboard.css?v={{ 'now'|date('YmdHis') }}">
    <style>
        {% if boutique.primaryColor %}
        :root {
            --primary: {{ boutique.primaryColor }};
        }
        {% endif %}

        .product-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px 40px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .product-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .product-title-section h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .product-ref {
            font-size: 14px;
            color: var(--gray-600);
            font-family: 'Courier New', monospace;
        }

        .product-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--gray-50), white);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--gray-200);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-icon {
            font-size: 20px;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-sublabel {
            font-size: 12px;
            color: var(--gray-500);
        }

        .stat-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-badge.critical { background: #fee2e2; color: #991b1b; }
        .stat-badge.warning { background: #fef3c7; color: #92400e; }
        .stat-badge.success { background: #d1fae5; color: #065f46; }

        .tabs-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .tabs-nav {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            padding: 0 24px;
            gap: 8px;
        }

        .tab-button {
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-600);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            top: 2px;
        }

        .tab-button:hover {
            color: var(--primary);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            padding: 32px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .info-card {
            background: var(--gray-50);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--gray-200);
        }

        .info-card h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .info-value {
            font-size: 14px;
            color: var(--gray-900);
            font-weight: 600;
        }

        .replenishment-card {
            background: linear-gradient(135deg, #fef3c7, #fef9e7);
            border: 2px solid #fbbf24;
            padding: 28px;
            border-radius: 20px;
            margin-bottom: 24px;
        }

        .replenishment-card h3 {
            font-size: 20px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .replenishment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .replenishment-stat {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .replenishment-stat-label {
            font-size: 12px;
            color: #78350f;
            margin-bottom: 8px;
        }

        .replenishment-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #92400e;
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--gray-200);
            color: var(--gray-700);
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        /* Tablet and small desktop */
        @media (max-width: 1024px) {
            .product-header {
                padding: 28px 24px;
                border-radius: 20px;
            }

            .product-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card {
                padding: 18px;
            }

            .stat-value {
                font-size: 28px;
            }

            .replenishment-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .tabs-container {
                border-radius: 20px;
            }
        }

        /* Mobile landscape and tablet portrait */
        @media (max-width: 768px) {
            .product-header {
                padding: 20px 16px;
                border-radius: 16px;
                margin-bottom: 16px;
            }

            .product-header-top {
                flex-direction: column;
                gap: 16px;
                margin-bottom: 20px;
            }

            .product-title-section h1 {
                font-size: 20px;
                line-height: 1.3;
            }

            .product-ref {
                font-size: 13px;
            }

            .product-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-card-header {
                margin-bottom: 10px;
            }

            .stat-icon {
                font-size: 18px;
            }

            .stat-label {
                font-size: 11px;
            }

            .stat-value {
                font-size: 24px;
                margin-bottom: 6px;
            }

            .stat-sublabel {
                font-size: 11px;
            }

            .replenishment-card {
                padding: 20px;
                border-radius: 16px;
                margin-bottom: 16px;
            }

            .replenishment-card h3 {
                font-size: 16px;
                margin-bottom: 14px;
            }

            .replenishment-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 16px;
            }

            .replenishment-stat {
                padding: 14px;
            }

            .replenishment-stat-label {
                font-size: 11px;
            }

            .replenishment-stat-value {
                font-size: 20px;
            }

            .tabs-container {
                border-radius: 16px;
            }

            .tabs-nav {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 16px;
                gap: 4px;
                scrollbar-width: none;
            }

            .tabs-nav::-webkit-scrollbar {
                display: none;
            }

            .tab-button {
                padding: 14px 18px;
                font-size: 13px;
                white-space: nowrap;
            }

            .tab-content {
                padding: 20px 16px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }

            .info-card {
                padding: 18px;
                border-radius: 12px;
            }

            .info-card h3 {
                font-size: 15px;
                margin-bottom: 14px;
            }

            .info-row {
                padding: 10px 0;
                flex-direction: column;
                gap: 4px;
                align-items: flex-start;
            }

            .info-label {
                font-size: 12px;
            }

            .info-value {
                font-size: 14px;
            }

            .period-selector-container {
                padding: 16px !important;
                border-radius: 16px !important;
                margin-bottom: 16px !important;
            }

            .period-selector-title {
                font-size: 14px !important;
                margin-bottom: 12px !important;
            }

            .period-selector {
                gap: 8px !important;
            }

            .period-btn-filter {
                padding: 8px 14px !important;
                font-size: 13px !important;
            }

            .custom-date-container {
                padding: 16px !important;
                margin-top: 12px !important;
            }

            .date-input-group {
                flex: 1;
                min-width: 140px;
            }

            .date-input-group input {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }

            .apply-date-btn {
                padding: 8px 16px !important;
                font-size: 13px !important;
            }

            .stats-summary {
                gap: 12px !important;
                margin-bottom: 16px !important;
                grid-template-columns: 1fr !important;
            }

            .summary-card {
                padding: 20px !important;
                border-radius: 16px !important;
            }

            .summary-card h3 {
                font-size: 11px !important;
                margin-bottom: 10px !important;
            }

            .summary-card > div {
                font-size: 28px !important;
            }

            .chart-container {
                padding: 16px !important;
                border-radius: 16px !important;
                margin-bottom: 16px !important;
            }

            .chart-container h2 {
                font-size: 16px !important;
                margin-bottom: 16px !important;
            }

            .chart-wrapper {
                height: 300px !important;
            }

            .btn-primary,
            .btn-secondary {
                padding: 10px 18px;
                font-size: 13px;
                width: 100%;
                justify-content: center;
            }

            table {
                font-size: 13px;
            }

            table th,
            table td {
                padding: 10px 8px !important;
            }
        }

        /* Small mobile */
        @media (max-width: 480px) {
            .product-header {
                padding: 16px 12px;
                border-radius: 12px;
            }

            .product-title-section h1 {
                font-size: 18px;
            }

            .product-stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 14px;
            }

            .stat-value {
                font-size: 28px;
            }

            .replenishment-card {
                padding: 16px;
            }

            .replenishment-card h3 {
                font-size: 15px;
                flex-wrap: wrap;
            }

            .replenishment-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .replenishment-stat {
                padding: 12px;
            }

            .replenishment-stat-value {
                font-size: 22px;
            }

            .tabs-nav {
                padding: 0 12px;
            }

            .tab-button {
                padding: 12px 14px;
                font-size: 12px;
            }

            .tab-content {
                padding: 16px 12px;
            }

            .info-card {
                padding: 16px;
            }

            .info-card h3 {
                font-size: 14px;
            }

            .info-row {
                padding: 8px 0;
            }

            .info-label,
            .info-value {
                font-size: 13px;
            }

            .period-selector-container {
                padding: 12px !important;
            }

            .period-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .period-btn-filter {
                width: 100%;
            }

            .custom-date-container > div {
                flex-direction: column;
                gap: 12px !important;
            }

            .date-input-group {
                width: 100%;
            }

            .apply-date-btn {
                width: 100%;
            }

            .chart-wrapper {
                height: 250px !important;
            }

            .summary-card {
                padding: 16px !important;
            }

            .summary-card > div {
                font-size: 24px !important;
            }

            table {
                font-size: 12px;
            }

            table th,
            table td {
                padding: 8px 6px !important;
            }

            table th:nth-child(4),
            table td:nth-child(4) {
                display: none;
            }
        }

        /* Very small screens */
        @media (max-width: 360px) {
            .product-title-section h1 {
                font-size: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            .stat-label {
                font-size: 10px;
            }

            .stat-sublabel {
                font-size: 10px;
            }

            .replenishment-stat-value {
                font-size: 20px;
            }

            .chart-wrapper {
                height: 220px !important;
            }
        }
    </style>
{% endblock %}

{% block body %}

<div class="product-header">
    <div class="product-header-top">
        <div class="product-title-section">
            <h1>{{ product.name }}</h1>
            {% if product.reference %}
                <div class="product-ref">R√©f: {{ product.reference }}</div>
            {% endif %}
        </div>
        <a href="{{ path('app_boutique_stocks', {id: boutique.id}) }}" class="btn-secondary">
            ‚Üê Retour aux stocks
        </a>
    </div>

    <div class="product-stats-grid">
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-icon">üì¶</span>
                <span class="stat-label">Stock</span>
            </div>
            <div class="stat-value">{{ product.quantity }}</div>
            <div class="stat-sublabel">
                {% if product.quantity <= 0 %}
                    <span class="stat-badge critical">Rupture</span>
                {% elseif product.quantity < boutique.lowStockThreshold %}
                    <span class="stat-badge warning">Stock faible</span>
                {% else %}
                    <span class="stat-badge success">En stock</span>
                {% endif %}
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-icon">üìà</span>
                <span class="stat-label">Ventes</span>
            </div>
            <div class="stat-value">{{ salesStats.total_quantity }}</div>
            <div class="stat-sublabel">{{ (replenishment.sales_velocity * 30)|round(1) }} /mois</div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-icon">üí∞</span>
                <span class="stat-label">Marge</span>
            </div>
            <div class="stat-value">{{ salesStats.margin_percent }}%</div>
            <div class="stat-sublabel">{{ salesStats.total_margin|number_format(2, ',', ' ') }} ‚Ç¨</div>
        </div>

        {% if replenishment.days_remaining < 999 %}
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-icon">‚è±Ô∏è</span>
                <span class="stat-label">Jours restants</span>
            </div>
            <div class="stat-value">{{ replenishment.days_remaining }}</div>
            <div class="stat-sublabel">{{ replenishment.sales_velocity|round(2) }} unit√©s/jour</div>
        </div>
        {% endif %}
    </div>
</div>

{% if replenishment.should_order %}
<div class="replenishment-card">
    <h3>
        {% if replenishment.urgency == 'critical' %}
            üî¥ R√©approvisionnement CRITIQUE
        {% elseif replenishment.urgency == 'urgent' %}
            üü† R√©approvisionnement URGENT
        {% elseif replenishment.urgency == 'warning' %}
            üü° R√©approvisionnement recommand√©
        {% else %}
            üí° Suggestion de r√©approvisionnement
        {% endif %}
    </h3>

    <div class="replenishment-grid">
        <div class="replenishment-stat">
            <div class="replenishment-stat-label">Quantit√© √† commander</div>
            <div class="replenishment-stat-value">{{ replenishment.needed_quantity }}</div>
        </div>
        <div class="replenishment-stat">
            <div class="replenishment-stat-label">Co√ªt total HT</div>
            <div class="replenishment-stat-value">{{ replenishment.total_cost_ht|number_format(0, ',', ' ') }} ‚Ç¨</div>
        </div>
        <div class="replenishment-stat">
            <div class="replenishment-stat-label">D√©lai livraison</div>
            <div class="replenishment-stat-value">{{ replenishment.lead_time_days }} jours</div>
        </div>
        <div class="replenishment-stat">
            <div class="replenishment-stat-label">R√©ception estim√©e</div>
            <div class="replenishment-stat-value">{{ replenishment.estimated_delivery_date|date('d/m') }}</div>
        </div>
    </div>

    <p style="margin-bottom: 16px; color: #92400e; font-size: 14px;">
        Pour tenir {{ replenishment.target_days }} jours au rythme actuel ({{ replenishment.sales_velocity|round(1) }} unit√©s/jour) avec un stock de s√©curit√© de {{ replenishment.safety_stock }} unit√©s.
    </p>

    <div style="display: flex; gap: 12px;">
        <button class="btn-primary">
            üìã G√©n√©rer bon de commande
        </button>
        {% if supplier %}
        <button class="btn-secondary">
            ‚úâÔ∏è Envoyer au fournisseur
        </button>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="tabs-container">
    <nav class="tabs-nav">
        <button class="tab-button active" onclick="switchTab(event, 'overview')">Vue d'ensemble</button>
        <button class="tab-button" onclick="switchTab(event, 'stock-history')">Historique stock</button>
        <button class="tab-button" onclick="switchTab(event, 'sales-history')">Historique ventes</button>
        {% if supplier %}
        <button class="tab-button" onclick="switchTab(event, 'supplier')">Fournisseur</button>
        {% endif %}
    </nav>

    <div id="overview" class="tab-content active">
        <div class="info-grid">
            <div class="info-card">
                <h3>üìù Informations g√©n√©rales</h3>
                <div class="info-row">
                    <span class="info-label">Nom</span>
                    <span class="info-value">{{ product.name }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">R√©f√©rence</span>
                    <span class="info-value">{{ product.reference ?? 'N/A' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Cat√©gorie</span>
                    <span class="info-value">{{ product.category ?? 'N/A' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Derni√®re MAJ</span>
                    <span class="info-value">{{ product.collectedAt|date('d/m/Y H:i') }}</span>
                </div>
            </div>

            <div class="info-card">
                <h3>üì¶ Stock & Disponibilit√©</h3>
                <div class="info-row">
                    <span class="info-label">Stock actuel</span>
                    <span class="info-value">{{ product.quantity }} unit√©s</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Seuil d'alerte</span>
                    <span class="info-value">{{ boutique.lowStockThreshold }} unit√©s</span>
                </div>
                {% if replenishment.days_remaining < 999 %}
                <div class="info-row">
                    <span class="info-label">Jours restants</span>
                    <span class="info-value">~{{ replenishment.days_remaining }} jours</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Rotation</span>
                    <span class="info-value">{{ replenishment.sales_velocity|round(2) }} unit√©s/jour</span>
                </div>
                {% endif %}
            </div>

            <div class="info-card">
                <h3>üìà Performances de vente</h3>
                <div class="info-row">
                    <span class="info-label">Total vendus</span>
                    <span class="info-value">{{ salesStats.total_quantity }} unit√©s</span>
                </div>
                <div class="info-row">
                    <span class="info-label">CA total</span>
                    <span class="info-value">{{ salesStats.total_revenue|number_format(2, ',', ' ') }} ‚Ç¨</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Prix moyen</span>
                    <span class="info-value">{{ salesStats.average_price|number_format(2, ',', ' ') }} ‚Ç¨</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Marge r√©alis√©e</span>
                    <span class="info-value">{{ salesStats.total_margin|number_format(2, ',', ' ') }} ‚Ç¨ ({{ salesStats.margin_percent }}%)</span>
                </div>
            </div>
        </div>
    </div>

    <div id="stock-history" class="tab-content">
        <div class="period-selector-container" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 20px; padding: 24px 30px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);">
            <div class="period-selector-title" style="font-size: 16px; font-weight: 700; color: var(--gray-700); margin-bottom: 16px;">P√©riode d'affichage</div>
            <div class="period-selector" style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button type="button" class="period-btn-filter" data-period="7" style="padding: 10px 20px; background: var(--gray-200); color: var(--gray-700); border-radius: 10px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">7 jours</button>
                <button type="button" class="period-btn-filter active" data-period="30" style="padding: 10px 20px; background: var(--primary); color: white; border-radius: 10px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">30 jours</button>
                <button type="button" class="period-btn-filter" data-period="90" style="padding: 10px 20px; background: var(--gray-200); color: var(--gray-700); border-radius: 10px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">90 jours</button>
                <button type="button" id="customPeriodBtn" class="period-btn-filter" style="padding: 10px 20px; background: var(--gray-200); color: var(--gray-700); border-radius: 10px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.2s;">P√©riode personnalis√©e</button>
                <label style="display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--gray-50); border-radius: 10px; cursor: pointer;">
                    <input type="checkbox" id="showOrdersCheck" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-size: 14px; font-weight: 600; color: var(--gray-700);">Afficher les commandes</span>
                </label>
            </div>

            <div id="customDateContainer" class="custom-date-container" style="display: none; background: var(--gray-50); padding: 20px; border-radius: 12px; margin-top: 16px;">
                <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="date-input-group" style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="font-weight: 600; color: var(--gray-700); font-size: 13px;">Date de d√©but</label>
                        <input type="date" id="customStartDate" style="padding: 10px 14px; border: 2px solid var(--gray-300); border-radius: 10px; font-size: 14px; background: white;">
                    </div>
                    <div class="date-input-group" style="display: flex; flex-direction: column; gap: 8px;">
                        <label style="font-weight: 600; color: var(--gray-700); font-size: 13px;">Date de fin</label>
                        <input type="date" id="customEndDate" style="padding: 10px 14px; border: 2px solid var(--gray-300); border-radius: 10px; font-size: 14px; background: white;">
                    </div>
                    <button type="button" id="applyCustomDates" class="apply-date-btn" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer;">Appliquer</button>
                </div>
            </div>
        </div>

        {% if stockHistory is not empty %}
            {% set firstStock = stockHistory|first %}
            {% set lastStock = stockHistory|last %}
            {% set totalQuantity = 0 %}
            {% for stock in stockHistory %}
                {% set totalQuantity = totalQuantity + stock.quantity %}
            {% endfor %}
            {% set avgStock = (totalQuantity / (stockHistory|length))|round %}
            {% set evolution = lastStock.quantity - firstStock.quantity %}

            <div id="statsContainer" class="stats-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px;">
                <div class="summary-card" style="background: white; padding: 28px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-left: 4px solid var(--primary); position: relative; overflow: hidden; transition: all 0.3s ease;">
                    <span style="position: absolute; top: 20px; right: 20px; font-size: 24px; opacity: 0.2;">üì¶</span>
                    <h3 style="font-size: 12px; color: var(--gray-600); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700;">Stock actuel</h3>
                    <div id="statCurrent" style="font-size: 36px; font-weight: 800; color: var(--gray-900); line-height: 1;">{{ lastStock.quantity }}</div>
                </div>
                <div class="summary-card" style="background: white; padding: 28px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-left: 4px solid #3b82f6; position: relative; overflow: hidden; transition: all 0.3s ease;">
                    <span style="position: absolute; top: 20px; right: 20px; font-size: 24px; opacity: 0.2;">üìä</span>
                    <h3 style="font-size: 12px; color: var(--gray-600); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700;">Stock moyen</h3>
                    <div id="statAverage" style="font-size: 36px; font-weight: 800; color: var(--gray-900); line-height: 1;">{{ avgStock }}</div>
                </div>
                <div class="summary-card" style="background: white; padding: 28px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border-left: 4px solid #f59e0b; position: relative; overflow: hidden; transition: all 0.3s ease;">
                    <span id="statEvoIcon" style="position: absolute; top: 20px; right: 20px; font-size: 24px; opacity: 0.2;">{{ evolution >= 0 ? 'üìà' : 'üìâ' }}</span>
                    <h3 style="font-size: 12px; color: var(--gray-600); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700;">√âvolution</h3>
                    <div id="statEvolution" style="font-size: 36px; font-weight: 800; color: {{ evolution >= 0 ? '#10b981' : '#ef4444' }}; line-height: 1;">
                        {{ evolution >= 0 ? '+' : '' }}{{ evolution }}
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="chart-container" style="background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 2rem;">
            <h2 style="margin-bottom: 24px; font-size: 20px; font-weight: 700;">üìà √âvolution du stock</h2>
            <div class="chart-wrapper" style="position: relative; height: 450px;">
                <canvas id="stockChart"></canvas>
            </div>
        </div>
    </div>

    <div id="sales-history" class="tab-content">
        <h2>Historique des ventes (50 derni√®res)</h2>
        {% if recentSales is empty %}
            <p>Aucune vente enregistr√©e</p>
        {% else %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--gray-200);">
                        <th style="padding: 12px; text-align: left;">Date</th>
                        <th style="padding: 12px; text-align: left;">Commande</th>
                        <th style="padding: 12px; text-align: right;">Quantit√©</th>
                        <th style="padding: 12px; text-align: right;">Prix unitaire</th>
                        <th style="padding: 12px; text-align: right;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in recentSales %}
                    <tr style="border-bottom: 1px solid var(--gray-200);">
                        <td style="padding: 12px;">{{ sale.orderDate|date('d/m/Y') }}</td>
                        <td style="padding: 12px;">{{ sale.reference }}</td>
                        <td style="padding: 12px; text-align: right;">{{ sale.quantity }}</td>
                        <td style="padding: 12px; text-align: right;">{{ sale.unitPrice|number_format(2, ',', ' ') }} ‚Ç¨</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">{{ sale.totalPrice|number_format(2, ',', ' ') }} ‚Ç¨</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

    {% if supplier %}
    <div id="supplier" class="tab-content">
        <div class="info-card">
            <h3>üè≠ Fournisseur Principal</h3>
            <div class="info-row">
                <span class="info-label">Nom</span>
                <span class="info-value">{{ supplier.name }}</span>
            </div>
            {% if supplier.contactName %}
            <div class="info-row">
                <span class="info-label">Contact</span>
                <span class="info-value">{{ supplier.contactName }}</span>
            </div>
            {% endif %}
            {% if supplier.email %}
            <div class="info-row">
                <span class="info-label">Email</span>
                <span class="info-value">{{ supplier.email }}</span>
            </div>
            {% endif %}
            {% if supplier.phone %}
            <div class="info-row">
                <span class="info-label">T√©l√©phone</span>
                <span class="info-value">{{ supplier.phone }}</span>
            </div>
            {% endif %}
            <div class="info-row">
                <span class="info-label">D√©lai de livraison</span>
                <span class="info-value">{{ supplier.leadTimeDays }} jours</span>
            </div>
            <div class="info-row">
                <span class="info-label">Quantit√© minimum</span>
                <span class="info-value">{{ productSupplier.minimumOrderQuantity ?? supplier.minimumOrderQuantity ?? 'N/A' }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Prix d'achat HT</span>
                <span class="info-value">{{ productSupplier.wholesalePrice|number_format(2, ',', ' ') }} ‚Ç¨</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
function switchTab(event, tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Remove active from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// Stock History Chart Management
let stockChart = null;
const boutiqueId = {{ boutique.id }};
const productId = {{ product.productId }};

// Load history data via AJAX
function loadHistoryData(period = '30', startDate = null, endDate = null, showOrders = false) {
    const url = new URL(`/boutique/${boutiqueId}/product/${productId}/history-data`, window.location.origin);
    url.searchParams.set('period', period);
    if (startDate) url.searchParams.set('startDate', startDate);
    if (endDate) url.searchParams.set('endDate', endDate);
    if (showOrders) url.searchParams.set('showOrders', '1');

    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('API Response:', data);
            console.log('Orders data:', data.orders);
            updateStats(data.stats);
            updateChart(data.history, data.orders);
        })
        .catch(error => console.error('Error loading history:', error));
}

// Update statistics cards
function updateStats(stats) {
    if (!stats) return;

    document.getElementById('statCurrent').textContent = stats.current;
    document.getElementById('statAverage').textContent = stats.average;

    const evolutionEl = document.getElementById('statEvolution');
    const evolutionIconEl = document.getElementById('statEvoIcon');
    evolutionEl.textContent = (stats.evolution >= 0 ? '+' : '') + stats.evolution;
    evolutionEl.style.color = stats.evolution >= 0 ? '#10b981' : '#ef4444';
    evolutionIconEl.textContent = stats.evolution >= 0 ? 'üìà' : 'üìâ';
}

// Update chart with new data
function updateChart(historyData, orderData) {
    if (!historyData || historyData.length === 0) return;

    // Group by date and keep only the latest entry per day
    const dataByDate = {};
    historyData.forEach(item => {
        const date = new Date(item.collectedAt);
        const dateKey = date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
        // Keep the latest entry for each date (or you could average them)
        if (!dataByDate[dateKey] || new Date(item.collectedAt) > new Date(dataByDate[dateKey].collectedAt)) {
            dataByDate[dateKey] = item;
        }
    });

    // Convert back to arrays and sort by date
    const sortedEntries = Object.entries(dataByDate).sort((a, b) => {
        return new Date(a[1].collectedAt) - new Date(b[1].collectedAt);
    });
    const labels = sortedEntries.map(entry => entry[0]);
    const stockQuantities = sortedEntries.map(entry => entry[1].quantity);

    const datasets = [{
        label: 'Stock',
        data: stockQuantities,
        borderColor: 'rgb(16, 185, 129)',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: 'rgb(16, 185, 129)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
    }];

    // Add orders data if available
    if (orderData && orderData.length > 0) {
        const orderQuantities = labels.map(label => {
            const order = orderData.find(o => {
                const orderDate = new Date(o.order_date);
                const orderLabel = orderDate.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
                return orderLabel === label;
            });
            return order ? parseInt(order.total_quantity) : 0;
        });

        datasets.push({
            label: 'Commandes',
            data: orderQuantities,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 5,
            pointBackgroundColor: 'rgb(59, 130, 246)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            yAxisID: 'y1',
        });
    }

    // Destroy existing chart if it exists
    if (stockChart) {
        stockChart.destroy();
    }

    // Create new chart
    const ctx = document.getElementById('stockChart');
    stockChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: { usePointStyle: true, padding: 20, font: { size: 13, weight: '600' } }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14, weight: 'bold' },
                    bodyFont: { size: 13 },
                    displayColors: true,
                    usePointStyle: true,
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Quantit√© en stock', font: { size: 13, weight: '600' } },
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: { font: { size: 12 } }
                },
                y1: {
                    type: 'linear',
                    display: orderData && orderData.length > 0,
                    position: 'right',
                    title: { display: true, text: 'Commandes', font: { size: 13, weight: '600' } },
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                    ticks: { font: { size: 12 } }
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 12 }, maxRotation: 45, minRotation: 45 }
                }
            }
        }
    });
}

// Period button click handlers
document.querySelectorAll('.period-btn-filter[data-period]').forEach(btn => {
    btn.addEventListener('click', function() {
        const period = this.getAttribute('data-period');
        const showOrders = document.getElementById('showOrdersCheck').checked;

        // Update active state
        document.querySelectorAll('.period-btn-filter').forEach(b => {
            b.classList.remove('active');
            b.style.background = 'var(--gray-200)';
            b.style.color = 'var(--gray-700)';
        });
        this.classList.add('active');
        this.style.background = 'var(--primary)';
        this.style.color = 'white';

        // Hide custom date container
        document.getElementById('customDateContainer').style.display = 'none';

        // Load data
        loadHistoryData(period, null, null, showOrders);
    });
});

// Custom period toggle
document.getElementById('customPeriodBtn')?.addEventListener('click', function() {
    const container = document.getElementById('customDateContainer');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
});

// Apply custom dates
document.getElementById('applyCustomDates')?.addEventListener('click', function() {
    const startDate = document.getElementById('customStartDate').value;
    const endDate = document.getElementById('customEndDate').value;
    const showOrders = document.getElementById('showOrdersCheck').checked;

    if (!startDate || !endDate) {
        alert('Veuillez s√©lectionner les deux dates');
        return;
    }

    // Update active state
    document.querySelectorAll('.period-btn-filter').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'var(--gray-200)';
        b.style.color = 'var(--gray-700)';
    });
    document.getElementById('customPeriodBtn').classList.add('active');
    document.getElementById('customPeriodBtn').style.background = 'var(--primary)';
    document.getElementById('customPeriodBtn').style.color = 'white';

    // Load data
    loadHistoryData('custom', startDate, endDate, showOrders);
});

// Show orders checkbox
document.getElementById('showOrdersCheck')?.addEventListener('change', function(e) {
    const activeBtn = document.querySelector('.period-btn-filter.active[data-period]');
    const period = activeBtn ? activeBtn.getAttribute('data-period') : '30';
    const showOrders = e.target.checked;

    // Check if custom period is active
    if (document.getElementById('customPeriodBtn').classList.contains('active')) {
        const startDate = document.getElementById('customStartDate').value;
        const endDate = document.getElementById('customEndDate').value;
        if (startDate && endDate) {
            loadHistoryData('custom', startDate, endDate, showOrders);
        }
    } else {
        loadHistoryData(period, null, null, showOrders);
    }
});

// Initial chart load
const historyData = {{ historyData|json_encode|raw }};
const orderData = {{ orderData|json_encode|raw }};
updateChart(historyData, orderData);
</script>

{% endblock %}
