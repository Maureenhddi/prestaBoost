{#
    Param√®tres :
    - activePeriod: '7', '30', '90', '' pour le bouton actif
    - showAllButton: true/false pour afficher le bouton "Tout"
    - showDateInputs: true/false pour afficher les inputs de dates
    - startDate: valeur du champ date d√©but
    - endDate: valeur du champ date fin
    - formId: ID du formulaire √† soumettre
    - cookieName: nom du cookie pour la persistance
    - inlineStyle: true/false pour inclure les styles CSS (mettre false si d√©j√† dans la page)
#}

{% if inlineStyle|default(true) %}
<style>
    .filters-period-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 16px 20px;
        margin-bottom: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .quick-period-btn {
        padding: 6px 12px;
        border: 2px solid var(--gray-300);
        border-radius: 8px;
        background: white;
        color: var(--gray-700);
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .quick-period-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .quick-period-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .period-dates-row {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .period-date-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .period-date-group label {
        font-size: 12px;
        font-weight: 600;
        color: var(--gray-700);
        white-space: nowrap;
    }

    .period-date-group input[type="date"] {
        padding: 6px 10px;
        border: 2px solid var(--gray-300);
        border-radius: 8px;
        font-size: 13px;
        transition: all 0.2s ease;
        width: 140px;
    }

    .period-date-group input[type="date"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    @media (max-width: 768px) {
        .period-dates-row {
            flex-direction: column;
        }
    }
</style>
{% endif %}

<div class="filters-period-card">
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <div style="display: flex; gap: 6px;">
            <button type="button" class="quick-period-btn {{ activePeriod == '7' ? 'active' : '' }}" data-period="7" data-cookie="{{ cookieName|default('period') }}" data-form="{{ formId|default('filtersForm') }}" title="Afficher les 7 derniers jours">7j</button>
            <button type="button" class="quick-period-btn {{ activePeriod == '30' ? 'active' : '' }}" data-period="30" data-cookie="{{ cookieName|default('period') }}" data-form="{{ formId|default('filtersForm') }}" title="Afficher les 30 derniers jours">30j</button>
            <button type="button" class="quick-period-btn {{ activePeriod == '90' ? 'active' : '' }}" data-period="90" data-cookie="{{ cookieName|default('period') }}" data-form="{{ formId|default('filtersForm') }}" title="Afficher les 90 derniers jours">90j</button>
            {% if showAllButton|default(false) %}
            <button type="button" class="quick-period-btn {{ activePeriod == '' ? 'active' : '' }}" data-period="" data-cookie="{{ cookieName|default('period') }}" data-form="{{ formId|default('filtersForm') }}" title="Afficher toutes les donn√©es disponibles">Tout</button>
            {% endif %}
        </div>

        {% if showDateInputs|default(true) %}
        <div style="display: flex; gap: 6px; align-items: center; margin-left: 8px; padding-left: 12px; border-left: 1px solid var(--gray-300);">
            <div class="period-date-group">
                <label for="period_start_date" title="Date de d√©but de la p√©riode √† analyser">Du</label>
                <input type="date" id="period_start_date" name="{{ dateStartName|default('start_date') }}" value="{{ startDate|default('') }}"
                       {% if minDate|default(false) %}min="{{ minDate }}"{% endif %}
                       {% if maxDate|default(false) %}max="{{ maxDate }}"{% endif %}
                       title="S√©lectionnez la date de d√©but pour filtrer les donn√©es">
            </div>
            <div class="period-date-group">
                <label for="period_end_date" title="Date de fin de la p√©riode √† analyser">au</label>
                <input type="date" id="period_end_date" name="{{ dateEndName|default('end_date') }}" value="{{ endDate|default('') }}"
                       {% if minDate|default(false) %}min="{{ minDate }}"{% endif %}
                       {% if maxDate|default(false) %}max="{{ maxDate }}"{% endif %}
                       title="S√©lectionnez la date de fin pour filtrer les donn√©es">
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
(function() {
    // Cookie helper functions
    function setCookie(name, value, days = 365) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/;SameSite=Lax";
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function initPeriodFilters() {
        console.log('üöÄ initPeriodFilters() called');

        // Get date inputs once at the beginning
        const startDateInput = document.getElementById('period_start_date');
        const endDateInput = document.getElementById('period_end_date');

        // Setup date validation if available dates are provided
        {% if availableDates|default(false) %}
        const availableDates = {{ availableDates|json_encode|raw }};
        console.log('üîç availableDates received:', availableDates);

        if (startDateInput && endDateInput && availableDates && availableDates.length > 0) {
            // Get date range from available dates
            const firstAvailableDate = new Date(availableDates[0]);
            const lastAvailableDate = new Date(availableDates[availableDates.length - 1]);
            const daysDiff = availableDates.length; // Use actual number of dates, not date range

            console.log('üìÖ Available date range:', availableDates[0], 'to', availableDates[availableDates.length - 1]);
            console.log('üìä Days of data available:', daysDiff);

            // Disable period buttons that exceed available data
            document.querySelectorAll('.quick-period-btn').forEach(btn => {
                const period = btn.getAttribute('data-period');
                if (period && parseInt(period) > daysDiff) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.title = `Seulement ${daysDiff} jours de donn√©es disponibles`;
                }
            });

            // Add tooltips
            const tooltip = `Donn√©es disponibles du ${availableDates[0]} au ${availableDates[availableDates.length - 1]} (${daysDiff} jours)`;
            startDateInput.title = tooltip;
            endDateInput.title = tooltip;

            // Validate selected dates
            function validateDate(input) {
                const selectedDate = input.value;
                if (selectedDate && !availableDates.includes(selectedDate)) {
                    input.style.borderColor = '#f59e0b';
                    input.style.background = '#fef3c7';
                } else {
                    input.style.borderColor = 'var(--gray-300)';
                    input.style.background = 'white';
                }
            }

            startDateInput.addEventListener('change', function() { validateDate(this); });
            endDateInput.addEventListener('change', function() { validateDate(this); });
        }
        {% endif %}

        // Handle quick period buttons
        const quickPeriodBtns = document.querySelectorAll('.quick-period-btn');
        console.log('üìä Found', quickPeriodBtns.length, 'period buttons');

        // Exit if no period buttons found (component not used on this page)
        if (quickPeriodBtns.length === 0) {
            console.log('‚ö†Ô∏è No period buttons found, exiting');
            return;
        }

        // Get cookie name from first button
        const firstBtn = quickPeriodBtns[0];
        const cookieName = firstBtn.getAttribute('data-cookie');
        let savedPeriod = getCookie(cookieName);

        // Check if there's a period in URL (from hidden input)
        const periodHiddenInput = document.getElementById('periodHiddenInput');
        const urlPeriod = periodHiddenInput ? periodHiddenInput.value : null;

        // If URL period exists and is different from cookie, update cookie
        if (urlPeriod && urlPeriod !== savedPeriod) {
            console.log('üîÑ Updating cookie from URL. Cookie:', savedPeriod, '‚Üí URL:', urlPeriod);
            setCookie(cookieName, urlPeriod);
            savedPeriod = urlPeriod;
        }

        // Force active state based on savedPeriod
        quickPeriodBtns.forEach(btn => {
            const btnPeriod = btn.getAttribute('data-period');

            // Remove any existing active class first
            btn.classList.remove('active');

            // Check if this button matches the saved period
            if (savedPeriod && btnPeriod === savedPeriod) {
                btn.classList.add('active');
                console.log('‚úÖ Setting button active:', btnPeriod);
            }
        });

        // Add click listeners
        quickPeriodBtns.forEach(btn => {
            const cookieName = btn.getAttribute('data-cookie');
            const formId = btn.getAttribute('data-form');

            btn.addEventListener('click', function(e) {
                const period = this.getAttribute('data-period');

                console.log('=== PERIOD BUTTON CLICKED ===');
                console.log('Period:', period);
                console.log('Form ID:', formId);
                console.log('Start date input exists:', !!startDateInput);
                console.log('End date input exists:', !!endDateInput);

                // Update hidden period input if exists
                const periodHiddenInput = document.getElementById('periodHiddenInput');
                if (periodHiddenInput) {
                    periodHiddenInput.value = period;
                    console.log('Updated hidden period input to:', period);
                }

                // Save period to cookie
                setCookie(cookieName, period);

                // Remove active class from all buttons
                quickPeriodBtns.forEach(b => b.classList.remove('active'));

                // Add active class to clicked button
                this.classList.add('active');

                if (period === '') {
                    // Clear date inputs for "Tout"
                    if (startDateInput) startDateInput.value = '';
                    if (endDateInput) endDateInput.value = '';
                    console.log('Cleared dates for "Tout"');
                } else {
                    // Calculate and set date range
                    const endDate = new Date();
                    const startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - parseInt(period));

                    console.log('Calculating dates for period:', period);
                    console.log('End date object:', endDate);
                    console.log('Start date object:', startDate);

                    // Format dates as YYYY-MM-DD
                    const formatDate = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };

                    // Update date inputs
                    if (startDateInput && endDateInput) {
                        const startStr = formatDate(startDate);
                        const endStr = formatDate(endDate);
                        console.log('Formatted start date:', startStr);
                        console.log('Formatted end date:', endStr);

                        startDateInput.value = startStr;
                        endDateInput.value = endStr;

                        console.log('Input values after setting:');
                        console.log('  startDateInput.value:', startDateInput.value);
                        console.log('  endDateInput.value:', endDateInput.value);
                        console.log('  startDateInput.name:', startDateInput.name);
                        console.log('  endDateInput.name:', endDateInput.name);
                    } else {
                        console.error('Date inputs not found!');
                    }
                }

                // Submit the form to apply filters
                const filterForm = document.getElementById(formId);
                console.log('Looking for form with ID:', formId);
                console.log('Form found:', !!filterForm);

                if (filterForm) {
                    console.log('Submitting form...');
                    console.log('Form action:', filterForm.action);
                    console.log('Form method:', filterForm.method);
                    filterForm.submit();
                } else {
                    console.error('Form not found with ID:', formId);
                }
            });
        });
    }

    // Run immediately if DOM already loaded, otherwise wait
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPeriodFilters);
    } else {
        initPeriodFilters();
    }
})();
</script>
