{% extends 'base.html.twig' %}

{% block title %}Historique - {{ boutique.name }}{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="/css/stocks.css?v={{ 'now'|date('YmdHis') }}">
    <style>
    {% if boutique.primaryColor %}
    :root {
        --primary: {{ boutique.primaryColor }};
    }

    body {
        background: linear-gradient(135deg, {{ boutique.primaryColor }} 0%, {{ boutique.primaryColor }}dd 100%);
    }

    body::before {
        background:
            radial-gradient(circle at 20% 50%, {{ boutique.primaryColor }}26 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, {{ boutique.primaryColor }}26 0%, transparent 50%),
            radial-gradient(circle at 40% 20%, {{ boutique.primaryColor }}26 0%, transparent 50%);
    }
    {% endif %}

    .chart-container {
        background: white;
        padding: 2rem;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
    }

    .period-selector {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .period-btn {
        padding: 0.625rem 1.25rem;
        background: var(--gray-100);
        color: var(--gray-700);
        text-decoration: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.875rem;
        transition: var(--transition);
        border: 1px solid var(--gray-200);
    }

    .period-btn:hover {
        background: var(--gray-200);
        transform: translateY(-2px);
    }

    .period-btn.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border-color: var(--primary);
        box-shadow: var(--shadow-sm), var(--glow-primary);
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .summary-card {
        background: white;
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        border-left: 4px solid;
    }

    .summary-card.green {
        border-left-color: var(--primary);
    }

    .summary-card.blue {
        border-left-color: #3b82f6;
    }

    .summary-card.orange {
        border-left-color: #f59e0b;
    }

    .summary-card h3 {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .summary-card .value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--gray-900);
    }
    </style>
{% endblock %}

{% block navbar %}
<div class="container">
    <nav class="navbar">
        <div class="navbar-brand">PrestaBoost</div>
        <ul class="navbar-menu">
            <li><a href="{{ path('app_dashboard') }}">Dashboard</a></li>
            {% if app.user.isSuperAdmin() %}
                <li><a href="{{ path('app_users') }}">Utilisateurs</a></li>
            {% endif %}
            <li><a href="{{ path('app_logout') }}">Déconnexion</a></li>
        </ul>
    </nav>
</div>
{% endblock %}

{% block body %}

<div class="page-header">
    <div class="page-title">
        <h1>Historique du produit</h1>
        <p>{{ history|first.name ?? 'Produit #' ~ productId }}</p>
    </div>
    <a href="{{ path('app_boutique_stocks', {id: boutique.id}) }}" class="btn btn-secondary">Retour</a>
</div>

{% if history is empty %}
    <div class="card">
        <div class="empty-state">
            <h3>Aucune donnée disponible</h3>
            <p>L'historique de ce produit n'est pas encore disponible.</p>
        </div>
    </div>
{% else %}
    <div class="period-selector">
        <a href="{{ path('app_product_history', {boutiqueId: boutique.id, productId: productId, period: 7}) }}"
           class="period-btn {{ period == '7' ? 'active' : '' }}">
            7 jours
        </a>
        <a href="{{ path('app_product_history', {boutiqueId: boutique.id, productId: productId, period: 30}) }}"
           class="period-btn {{ period == '30' ? 'active' : '' }}">
            30 jours
        </a>
        <a href="{{ path('app_product_history', {boutiqueId: boutique.id, productId: productId, period: 90}) }}"
           class="period-btn {{ period == '90' ? 'active' : '' }}">
            90 jours
        </a>
    </div>

    {% set firstStock = history|last %}
    {% set lastStock = history|first %}
    {% set evolution = lastStock.quantity - firstStock.quantity %}
    {% set avgStock = (history|reduce((sum, item) => sum + item.quantity, 0) / history|length)|round %}

    <div class="stats-summary">
        <div class="summary-card green">
            <h3>Stock actuel</h3>
            <div class="value">{{ lastStock.quantity }}</div>
        </div>
        <div class="summary-card blue">
            <h3>Stock moyen</h3>
            <div class="value">{{ avgStock }}</div>
        </div>
        <div class="summary-card orange">
            <h3>Évolution</h3>
            <div class="value" style="color: {{ evolution >= 0 ? '#10b981' : '#ef4444' }}">
                {{ evolution >= 0 ? '+' : '' }}{{ evolution }}
            </div>
        </div>
    </div>

    <div class="chart-container">
        <h3 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 700;">Évolution du stock</h3>
        <div class="chart-wrapper">
            <canvas id="stockChart"></canvas>
        </div>
    </div>
{% endif %}

{% endblock %}

{% block javascripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('stockChart');
    if (!ctx) return;

    const history = {{ history|json_encode|raw }};

    // Prepare data (reverse to show chronological order)
    const labels = history.reverse().map(item => {
        const date = new Date(item.collectedAt);
        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
    });

    const data = history.map(item => item.quantity);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantité en stock',
                data: data,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    cornerRadius: 8
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
